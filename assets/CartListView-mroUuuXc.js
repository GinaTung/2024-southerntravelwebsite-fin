import{C as w}from"./CartNavbar-fp-xljIu.js";import{M}from"./bootstrap.esm--NjF4xBI.js";import{_ as k,o as i,c as h,a as t,t as f,d as b,b as C,k as y,F as x,h as L,w as I,g as T,r as D,f as $,j as S,p as E,i as P}from"./index-YauCT9D4.js";import{s as p}from"./sweetAlert-VBzzWPiK.js";const V={props:{userCarts:Array,deleteCart:Function,saveCartsDelModal:Object},data(){return{delModal:null}},methods:{openModal(){this.delModal.show()},closeModal(){this.delModal.hide()}},mounted(){this.delModal=new M(this.$refs.delCartModal)}},N={class:"modal fade",id:"delCartModal",tabindex:"-1",role:"dialog","aria-labelledby":"exampleModalLabel","aria-hidden":"true",ref:"delCartModal"},B={class:"modal-dialog",role:"document"},F={class:"modal-content border-0"},j={class:"modal-header bg-danger text-white"},A={class:"modal-title"},Q=t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"},null,-1),U={class:"modal-body"},q={class:"text-danger me-2"},G=t("br",null,null,-1),z={class:"text-primary"},O={class:"modal-footer"},H=t("button",{type:"button",class:"btn btn-outline-secondary","data-bs-dismiss":"modal"}," 取消 ",-1);function J(e,a,d,o,s,l){return i(),h("div",N,[t("div",B,[t("div",F,[t("div",j,[t("h5",A,[t("span",null,"刪除購物車編號: "+f(d.saveCartsDelModal.cartId),1)]),Q]),t("div",U,[b(" 是否刪除 "),t("strong",q,"預約行程名稱："+f(d.saveCartsDelModal.productTitle),1),G,t("span",z,"預約數量："+f(d.saveCartsDelModal.qty)+"位",1),b("(刪除後將無法恢復)。 ")]),t("div",O,[H,t("button",{type:"button",class:"btn btn-danger",onClick:a[0]||(a[0]=c=>d.deleteCart(d.saveCartsDelModal.cartId,d.saveCartsDelModal.productTitle))},"確認刪除")])])])],512)}const K=k(V,[["render",J]]),_="https://two024-south-json-server-vercel.onrender.com",R={components:{CartNavbar:w,DelCartModal:K},data(){return{userId:"",products:[],enabledProducts:[],carts:[],userCarts:[],newCarts:[],saveCartsDelModal:{},cartsData:[],isCartProductsFetched:!1,isGetProductsTriggered:!1,isGetCartsTriggered:!1,quantity:"",cartIdData:[],resData:[],isLoading:!1,status:{loadingItem:!1,loadingItem2:"",loadingItem3:"",loadingItem4:"",loadingItem5:""},cartsLength:0}},methods:{getCarts(){this.axios.get(`${_}/carts`).then(e=>{this.carts=e.data,this.carts.forEach(a=>{a.userId===this.userId&&this.userCarts.push(a)}),this.cartsLength=this.userCarts.length,this.getProducts()}).catch(e=>{p.threeLayerCheckType("error","取得購物車資料失敗")})},getCart(){this.axios.get(`${_}/carts`).then(e=>{this.userCarts=e.data.filter(a=>a.userId===this.userId),this.cartsLength=this.userCarts.length,this.userCarts.length===0?this.$emitter.emit("updateCartNum",0):this.$emitter.emit("updateCartNum",this.userCarts.length)}).catch(e=>{p.threeLayerCheckType("error","取得購物車資料失敗")})},deleteCart(e,a){this.status.loadingItem3=e,this.status.loadingItem=!0,this.$refs.delModal.closeModal(),this.axios.delete(`${_}/carts/${e}`).then(d=>{this.status.loadingItem3="",this.cartsData=this.cartsData.filter(l=>l.id!==e);let o=0;this.cartsData.forEach(l=>{o+=l.final_total}),this.cartsData.total=o;let s=1;this.cartsData.final_total=o*s,this.status.loadingItem=!1,this.getCart()}).catch(d=>{this.status.loadingItem3="",p.threeLayerCheckType("error","刪除購物車資料失敗"),this.status.loadingItem=!1})},openDelCartModal(e,a,d,o){Array.isArray(this.userCarts)||(this.userCarts=[]),this.saveCartsDelModal={cartId:d,productId:e,productTitle:a,qty:o},this.$refs.delModal.openModal()},thousand(e){return e!==void 0&&(e=e.toString().replace(new RegExp("\\B(?<!\\.\\d*)(?=(\\d{3})+(?!\\d))","g"),",")),`$ ${e}`},getProducts(){this.axios.get(`${_}/products`).then(e=>{this.products=e.data,this.products.forEach(o=>{o.is_enabled===1&&this.enabledProducts.push(o)});let a=0;this.userCarts.forEach(o=>{const s=o.productId,l=this.enabledProducts.find(c=>c.id===s);l&&(o.product=l,a+=o.final_total,this.cartsData.push(o))}),this.isLoading=!1,this.cartsData.total=a;let d=1;this.cartsData.final_total=a*d}).catch(e=>{this.isLoading=!1,p.threeLayerCheckType("error","取得產品資料失敗")})},incrementQuantity(e,a,d,o){if(this.status.loadingItem2=e,a<o){a+=1;let s=1;this.axios.patch(`${_}/carts/${e}`,{qty:a,price:d,total:a*d,final_total:a*d*s}).then(l=>{this.status.loadingItem2="";const c=this.cartsData.findIndex(u=>u.id===e);if(c!==-1){this.cartsData[c].qty=a,this.cartsData[c].final_total=a*d*s;let u=0;this.cartsData.forEach(m=>{u+=m.final_total}),this.cartsData.total=u,this.cartsData.final_total=u*s}}).catch(l=>{p.threeLayerCheckType("error","增加購物車預約數量失敗")})}else this.status.loadingItem2="",p.threeLayerCheckType("warning",`預約人數上限為${o}人`)},decrementQuantity(e,a,d){if(this.status.loadingItem4=e,a>1){a-=1;let o=1;this.axios.patch(`${_}/carts/${e}`,{qty:a,price:d,total:a*d,final_total:a*d*o}).then(s=>{this.status.loadingItem4="";const l=this.cartsData.findIndex(c=>c.id===e);if(l!==-1){this.cartsData[l].qty=a,this.cartsData[l].final_total=a*d*o;let c=0;this.cartsData.forEach(u=>{c+=u.final_total}),this.cartsData.total=c,this.cartsData.final_total=c*o}}).catch(s=>{this.status.loadingItem4="",alert("更新購物車資料失敗")})}},back(){this.$router.back()},getCookie(e){const a=document.cookie.split(";");for(let d of a){const[o,s]=d.trim().split("=");if(o===e)return s}return null},getCartSData(){this.axios.get(`${_}/cartsData`).then(e=>{this.cartIdData=e.data})},saveCartData(e,a){const d=this.cartIdData.some(s=>s.userId===this.userId&&s.status===!1);let o=0;this.cartIdData.forEach(s=>{s.userId===this.userId&&s.status===!1&&(o=s.id)}),d&&o!==0?this.axios.put(`${_}/cartsData/${o}`,{data:this.cartsData,total:a,final_total:e,status:!1,userId:this.userId,orderStatus:!1}).then(s=>{document.cookie=`cartDataId=${o}`,this.getCartSData()}).catch(s=>{p.threeLayerCheckType("error","更新購物車資料失敗")}):this.axios.post(`${_}/cartsData`,{data:this.cartsData,total:a,final_total:e,status:!1,userId:this.userId,orderStatus:!1}).then(s=>{document.cookie=`cartDataId=${s.data.id}`,this.getCartSData()}).catch(s=>{p.threeLayerCheckType("error","儲存購物車資料失敗")})}},mounted(){const e=this.getCookie("userId");this.userId=e*1,this.isLoading=!0,this.getCarts(),this.getCartSData(),window.scrollTo(0,0)}},n=e=>(E("data-v-ff0901e3"),e=e(),P(),e),W={class:"container py-10 py-lg-30"},X={class:"row"},Y={class:"col-md-6 mx-auto pb-5 pb-lg-15"},Z={class:"table-responsive"},tt={class:"table align-middle table-rwd"},st=n(()=>t("tr",{class:"tr-only-hide"},[t("th",{style:{width:"100px"}}),t("th",{style:{width:"170px"}},"圖片"),t("th",{style:{width:"170px"}},"行程名稱"),t("th",{style:{width:"170px"}},"數量/單位"),t("th",{style:{width:"100px"},class:"text-end"},"單價"),t("th",{class:"text-end",style:{width:"100px"}},"小計")],-1)),et={key:0,class:"d-md-none"},at=n(()=>t("th",{style:{width:"80px"}},null,-1)),ot=n(()=>t("th",{style:{width:"170px"}},"圖片",-1)),rt=n(()=>t("th",{style:{width:"170px"}},"行程名稱",-1)),dt=n(()=>t("th",{style:{width:"170px"}},"數量/單位",-1)),lt=n(()=>t("th",{style:{width:"100px"},class:"text-end"},"單價",-1)),nt=n(()=>t("th",{class:"text-end",style:{width:"100px"}},"小計",-1)),it=[at,ot,rt,dt,lt,nt],ct={key:0},ht=n(()=>t("tr",null,[t("td",{colspan:"6",class:"text-center",style:{height:"150px"}},[t("div",{class:"spinner-border",role:"status",style:{width:"3rem",height:"3rem",color:"#43b8bd"}},[t("span",{class:"visually-hidden"},"Loading...")])])],-1)),ut=[ht],_t={key:0},pt=n(()=>t("td",{colspan:"6",class:"text-center"},"購物車是空的",-1)),ft=[pt],bt={"data-th":""},gt=["onClick"],mt=n(()=>t("i",{class:"bi bi-x"},null,-1)),Ct={"data-th":"圖片",class:""},yt=["src","alt"],Dt={"data-th":"行程名稱",class:"fs-6 pb-0 pb-md-2"},xt={class:"td-p-left"},It={class:"py-0 py-md-2"},kt={class:"td-number-direction"},vt=n(()=>t("span",{class:"fw-bold d-md-none fs-6"},"數量/單位",-1)),wt={class:"input-group my-3 w-length"},Mt=["onClick"],Lt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Tt=n(()=>t("i",{class:"bi bi-dash-lg"},null,-1)),$t=["onClick"],St={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Et=n(()=>t("i",{class:"bi bi-trash"},null,-1)),Pt=["disabled","onUpdate:modelValue"],Vt=["onClick"],Nt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Bt=n(()=>t("i",{class:"bi bi-plus-lg"},null,-1)),Ft={"data-th":"單價",class:"text-end"},jt={class:"td-p-left"},At={class:"text-end","data-th":"小計"},Qt={class:"td-p-left"},Ut={class:"tr-border-bottom-0"},qt={colspan:"6",class:"text-end text-success"},Gt=n(()=>t("span",{class:"td-p-right"},"預約",-1)),zt={class:"tr-border-bottom-0"},Ot={colspan:"6",class:"text-end fs-5"},Ht=n(()=>t("span",{class:"td-p-right"},"總計 ",-1)),Jt={class:"d-flex justify-content-between"},Kt={key:0,class:"btn btn-danger mt-4 fs-5 w-50 w-md-25 disabled btn-danger-rounded",type:"button"};function Rt(e,a,d,o,s,l){const c=D("VueLoading"),u=D("CartNavbar"),m=D("router-link"),v=D("del-cart-modal");return i(),h(x,null,[C(c,{active:s.isLoading,class:"text-center","z-index":1060},null,8,["active"]),t("div",W,[t("div",X,[t("div",Y,[C(u)])]),t("div",Z,[t("table",tt,[t("thead",null,[st,s.cartsData.length===0?(i(),h("tr",et,it)):y("",!0)]),s.status.loadingItem?(i(),h("tbody",ct,ut)):(i(),h(x,{key:1},[t("tbody",null,[s.cartsData.length===0?(i(),h("tr",_t,ft)):(i(!0),h(x,{key:1},L(s.cartsData,r=>(i(),h("tr",{key:r.id},[t("td",bt,[t("button",{type:"button",class:"btn btn-outline-danger btn-sm",onClick:g=>l.openDelCartModal(r.productId,r.product.title,r.id,r.qty)},[mt,b("刪除 ")],8,gt)]),t("td",Ct,[t("img",{src:r.product.imageUrl,alt:r.product.title,class:"img-fluid"},null,8,yt)]),t("td",Dt,[t("span",xt,f(r.product.title),1)]),t("td",It,[t("div",kt,[vt,t("div",wt,[r.qty>1?(i(),h("button",{key:0,class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",onClick:g=>l.decrementQuantity(r.id,r.qty,r.price)},[s.status.loadingItem4===r.id?(i(),h("span",Lt)):y("",!0),Tt],8,Mt)):(i(),h("button",{key:1,type:"button",class:"btn btn-outline-danger rounded-0 btn-sm",onClick:g=>l.openDelCartModal(r.productId,r.product.title,r.id,r.qty)},[s.status.loadingItem3===r.id?(i(),h("span",St)):y("",!0),Et],8,$t)),$(t("input",{min:"1",max:"10",type:"number",disabled:r.qty>10,class:"form-control rounded-0 border border-dark d-flex","onUpdate:modelValue":g=>r.qty=g,readonly:"",style:{"text-align":"center"}},null,8,Pt),[[S,r.qty]]),t("button",{class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",onClick:g=>l.incrementQuantity(r.id,r.qty,r.price,r.product.max_travelers)},[s.status.loadingItem2===r.id?(i(),h("span",Nt)):y("",!0),Bt],8,Vt)])])]),t("td",Ft,[t("span",jt,f(l.thousand(r.price)),1)]),t("td",At,[t("span",Qt,f(l.thousand(r.final_total)),1)])]))),128))]),t("tfoot",null,[t("tr",Ut,[t("td",qt,[Gt,b(" "+f(s.cartsData?s.cartsData.length:0)+" 項旅遊方案 ",1)])]),t("tr",zt,[t("td",Ot,[Ht,b(" "+f(s.cartsData&&s.cartsData.final_total!==void 0?l.thousand(s.cartsData.final_total):0)+" 元 ",1)])])])],64))])]),t("div",Jt,[C(m,{class:"btn-outline-square w-50 w-md-25 fs-5 mt-4 me-1",to:"/TouristPackage"},{default:I(()=>[b("繼續預約")]),_:1}),s.cartsLength===0?(i(),h("button",Kt," 請預約旅遊方案 ")):(i(),T(m,{key:1,class:"btn-square mt-4 fs-5 w-50 w-md-25",to:"/cart/CartForm",onClick:a[0]||(a[0]=r=>l.saveCartData(s.cartsData.final_total,s.cartsData.total))},{default:I(()=>[b("下一步")]),_:1}))])]),C(v,{ref:"delModal","user-carts":s.userCarts,"delete-cart":l.deleteCart,"save-carts-del-modal":s.saveCartsDelModal},null,8,["user-carts","delete-cart","save-carts-del-modal"])],64)}const ts=k(R,[["render",Rt],["__scopeId","data-v-ff0901e3"]]);export{ts as default};
