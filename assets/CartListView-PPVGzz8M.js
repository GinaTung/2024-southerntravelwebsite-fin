import{C as w}from"./CartNavbar-jrb2gSDS.js";import{M}from"./bootstrap.esm-JGUdTYd5.js";import{_ as v,o as c,c as h,a as t,t as g,d as f,b as y,j as D,F as x,h as T,w as I,g as L,r as C,i as $,v as P,p as S,f as E}from"./index-zgOFFbyg.js";import{s as u}from"./sweetAlert-69o1uZdh.js";const V={props:{userCarts:Array,deleteCart:Function,saveCartsDelModal:Object},data(){return{delModal:null}},methods:{openModal(){this.delModal.show()},closeModal(){this.delModal.hide()}},mounted(){this.delModal=new M(this.$refs.delCartModal)}},N={class:"modal fade",id:"delCartModal",tabindex:"-1",role:"dialog","aria-labelledby":"exampleModalLabel","aria-hidden":"true",ref:"delCartModal"},A={class:"modal-dialog",role:"document"},F={class:"modal-content border-0"},B={class:"modal-header bg-danger text-white"},j={class:"modal-title"},Q=t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"},null,-1),U={class:"modal-body"},q={class:"text-danger me-2"},G=t("br",null,null,-1),z={class:"text-primary"},H={class:"modal-footer"},O=t("button",{type:"button",class:"btn btn-outline-secondary","data-bs-dismiss":"modal"}," 取消 ",-1);function J(s,a,r,o,e,l){return c(),h("div",N,[t("div",A,[t("div",F,[t("div",B,[t("h5",j,[t("span",null,"刪除購物車編號: "+g(r.saveCartsDelModal.cartId),1)]),Q]),t("div",U,[f(" 是否刪除 "),t("strong",q,"預約行程名稱："+g(r.saveCartsDelModal.productTitle),1),G,t("span",z,"預約數量："+g(r.saveCartsDelModal.qty)+"位",1),f("(刪除後將無法恢復)。 ")]),t("div",H,[O,t("button",{type:"button",class:"btn btn-danger",onClick:a[0]||(a[0]=n=>r.deleteCart(r.saveCartsDelModal.cartId,r.saveCartsDelModal.productTitle))},"確認刪除")])])])],512)}const K=v(V,[["render",J]]),p="https://two024-south-json-server-vercel.onrender.com",R={components:{CartNavbar:w,DelCartModal:K},data(){return{userId:"",products:[],enabledProducts:[],carts:[],userCarts:[],newCarts:[],saveCartsDelModal:{},cartsData:[],isCartProductsFetched:!1,isGetProductsTriggered:!1,isGetCartsTriggered:!1,quantity:"",cartIdData:[],resData:[],isLoading:!1,status:{loadingItem:!1,loadingItem2:"",loadingItem3:"",loadingItem4:"",loadingItem5:""},cartsLength:0}},methods:{redirectToA(s){this.$root.navigatedFromHeader=!0,this.$router.push({path:"/TouristPackage",query:{category:s}})},getCarts(){this.axios.get(`${p}/carts`).then(s=>{this.carts=s.data,this.carts.forEach(a=>{a.userId===this.userId&&this.userCarts.push(a)}),this.cartsLength=this.userCarts.length,this.cartsLength===0&&(u.fourLayerCheckType("warning","目前無購物車資料","將在","秒後自動跳轉至旅遊景點方案頁面","預約購買旅遊方案"),setTimeout(()=>{this.$router.push({path:"/TouristPackage",query:{category:"全部"}})},11e3)),this.getProducts()}).catch(s=>{u.threeLayerCheckType("error","取得購物車資料失敗")})},getCart(){this.axios.get(`${p}/carts`).then(s=>{this.userCarts=s.data.filter(a=>a.userId===this.userId),this.cartsLength=this.userCarts.length,this.userCarts.length===0?(this.$emitter.emit("updateCartNum",0),u.fourLayerCheckType("warning","目前無購物車資料","將在","秒後自動跳轉至旅遊景點方案頁面","預約購買旅遊方案"),setTimeout(()=>{this.$router.push({path:"/TouristPackage"})},11e3)):this.$emitter.emit("updateCartNum",this.userCarts.length)}).catch(s=>{u.threeLayerCheckType("error","取得購物車資料失敗")})},deleteCart(s,a){this.status.loadingItem3=s,this.status.loadingItem=!0,this.$refs.delModal.closeModal(),this.axios.delete(`${p}/carts/${s}`).then(r=>{this.status.loadingItem3="",this.cartsData=this.cartsData.filter(l=>l.id!==s);let o=0;this.cartsData.forEach(l=>{o+=l.final_total}),this.cartsData.total=o;let e=1;this.cartsData.final_total=o*e,this.status.loadingItem=!1,this.getCart()}).catch(r=>{this.status.loadingItem3="",u.threeLayerCheckType("error","刪除購物車資料失敗"),this.status.loadingItem=!1})},openDelCartModal(s,a,r,o){Array.isArray(this.userCarts)||(this.userCarts=[]),this.saveCartsDelModal={cartId:r,productId:s,productTitle:a,qty:o},this.$refs.delModal.openModal()},thousand(s){return s!==void 0&&(s=s.toString().replace(new RegExp("\\B(?<!\\.\\d*)(?=(\\d{3})+(?!\\d))","g"),",")),`$ ${s}`},getProducts(){this.axios.get(`${p}/products`).then(s=>{this.products=s.data,this.products.forEach(o=>{o.is_enabled===1&&this.enabledProducts.push(o)});let a=0;this.userCarts.forEach(o=>{const e=o.productId,l=this.enabledProducts.find(n=>n.id===e);l&&(o.product=l,a+=o.final_total,this.cartsData.push(o))}),this.isLoading=!1,this.cartsData.total=a;let r=1;this.cartsData.final_total=a*r}).catch(s=>{this.isLoading=!1,u.threeLayerCheckType("error","取得產品資料失敗")})},incrementQuantity(s,a,r,o){if(this.status.loadingItem2=s,a<o){a+=1;let e=1;this.axios.patch(`${p}/carts/${s}`,{qty:a,price:r,total:a*r,final_total:a*r*e}).then(l=>{this.status.loadingItem2="";const n=this.cartsData.findIndex(_=>_.id===s);if(n!==-1){this.cartsData[n].qty=a,this.cartsData[n].final_total=a*r*e;let _=0;this.cartsData.forEach(b=>{_+=b.final_total}),this.cartsData.total=_,this.cartsData.final_total=_*e}}).catch(l=>{u.threeLayerCheckType("error","增加購物車預約數量失敗")})}else this.status.loadingItem2="",u.threeLayerCheckType("warning",`預約人數上限為${o}人`)},decrementQuantity(s,a,r){if(this.status.loadingItem4=s,a>1){a-=1;let o=1;this.axios.patch(`${p}/carts/${s}`,{qty:a,price:r,total:a*r,final_total:a*r*o}).then(e=>{this.status.loadingItem4="";const l=this.cartsData.findIndex(n=>n.id===s);if(l!==-1){this.cartsData[l].qty=a,this.cartsData[l].final_total=a*r*o;let n=0;this.cartsData.forEach(_=>{n+=_.final_total}),this.cartsData.total=n,this.cartsData.final_total=n*o}}).catch(e=>{this.status.loadingItem4="",alert("更新購物車資料失敗")})}else this.status.loadingItem2=""},back(){this.$router.back()},getCookie(s){const a=document.cookie.split(";");for(let r of a){const[o,e]=r.trim().split("=");if(o===s)return e}return null},getCartSData(){this.axios.get(`${p}/cartsData`).then(s=>{this.cartIdData=s.data})},saveCartData(s,a){const r=this.cartIdData.some(e=>e.userId===this.userId&&e.status===!1);let o=0;this.cartIdData.forEach(e=>{e.userId===this.userId&&e.status===!1&&(o=e.id)}),r&&o!==0?this.axios.put(`${p}/cartsData/${o}`,{data:this.cartsData,total:a,final_total:s,status:!1,userId:this.userId,orderStatus:!1}).then(e=>{document.cookie=`cartDataId=${o}`,this.getCartSData()}).catch(e=>{u.threeLayerCheckType("error","更新購物車資料失敗")}):this.axios.post(`${p}/cartsData`,{data:this.cartsData,total:a,final_total:s,status:!1,userId:this.userId,orderStatus:!1}).then(e=>{document.cookie=`cartDataId=${e.data.id}`,this.getCartSData()}).catch(e=>{u.threeLayerCheckType("error","儲存購物車資料失敗")})}},mounted(){const s=this.getCookie("userId");this.userId=s*1,this.isLoading=!0,this.getCarts(),this.getCartSData(),window.scrollTo(0,0)}},i=s=>(S("data-v-3efa3263"),s=s(),E(),s),W={class:"container py-10 py-lg-30"},X={class:"row"},Y={class:"col-md-6 mx-auto pb-5 pb-lg-15"},Z={class:"table-responsive"},tt={class:"table align-middle table-rwd"},st=i(()=>t("tr",{class:"tr-only-hide"},[t("th",{style:{width:"100px"}}),t("th",{style:{width:"170px"}},"圖片"),t("th",{style:{width:"170px"}},"行程名稱"),t("th",{style:{width:"170px"}},"數量/單位"),t("th",{style:{width:"100px"},class:"text-end"},"單價"),t("th",{class:"text-end",style:{width:"100px"}},"小計")],-1)),et={key:0,class:"d-md-none"},at=i(()=>t("th",{style:{width:"80px"}},null,-1)),ot=i(()=>t("th",{style:{width:"170px"}},"圖片",-1)),rt=i(()=>t("th",{style:{width:"170px"}},"行程名稱",-1)),dt=i(()=>t("th",{style:{width:"170px"}},"數量/單位",-1)),lt=i(()=>t("th",{style:{width:"100px"},class:"text-end"},"單價",-1)),it=i(()=>t("th",{class:"text-end",style:{width:"100px"}},"小計",-1)),nt=[at,ot,rt,dt,lt,it],ct={key:0},ht=i(()=>t("tr",null,[t("td",{colspan:"6",class:"text-center",style:{height:"150px"}},[t("div",{class:"spinner-border",role:"status",style:{width:"3rem",height:"3rem",color:"#43b8bd"}},[t("span",{class:"visually-hidden"},"Loading...")])])],-1)),ut=[ht],_t={key:0},pt=i(()=>t("td",{colspan:"6",class:"text-center"},"購物車是空的",-1)),gt=[pt],ft={"data-th":""},bt=["onClick"],mt=i(()=>t("i",{class:"bi bi-x"},null,-1)),yt={"data-th":"圖片",class:""},Ct=["src","alt"],Dt={"data-th":"行程名稱",class:"fs-6 pb-0 pb-md-2"},xt={class:"td-p-left"},It={class:"py-0 py-md-2"},vt={class:"td-number-direction"},kt=i(()=>t("span",{class:"fw-bold d-md-none fs-6"},"數量/單位",-1)),wt={class:"input-group my-3 w-length"},Mt=["disabled","onClick"],Tt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Lt=i(()=>t("i",{class:"bi bi-dash-lg"},null,-1)),$t=["disabled","onUpdate:modelValue"],Pt=["onClick"],St={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Et=i(()=>t("i",{class:"bi bi-plus-lg"},null,-1)),Vt={"data-th":"單價",class:"text-end"},Nt={class:"td-p-left"},At={class:"text-end","data-th":"小計"},Ft={class:"td-p-left"},Bt={class:"tr-border-bottom-0"},jt={colspan:"6",class:"text-end text-success"},Qt=i(()=>t("span",{class:"td-p-right"},"預約",-1)),Ut={class:"tr-border-bottom-0"},qt={colspan:"6",class:"text-end fs-5"},Gt=i(()=>t("span",{class:"td-p-right"},"總計 ",-1)),zt={class:"d-flex justify-content-between"},Ht={key:0,class:"btn btn-danger mt-4 fs-5 w-50 w-md-25 disabled btn-danger-rounded",type:"button"};function Ot(s,a,r,o,e,l){const n=C("VueLoading"),_=C("CartNavbar"),b=C("router-link"),k=C("del-cart-modal");return c(),h(x,null,[y(n,{active:e.isLoading,class:"text-center","z-index":1060},null,8,["active"]),t("div",W,[t("div",X,[t("div",Y,[y(_)])]),t("div",Z,[t("table",tt,[t("thead",null,[st,e.cartsData.length===0?(c(),h("tr",et,nt)):D("",!0)]),e.status.loadingItem?(c(),h("tbody",ct,ut)):(c(),h(x,{key:1},[t("tbody",null,[e.cartsData.length===0?(c(),h("tr",_t,gt)):(c(!0),h(x,{key:1},T(e.cartsData,d=>(c(),h("tr",{key:d.id},[t("td",ft,[t("button",{type:"button",class:"btn btn-outline-danger btn-sm",onClick:m=>l.openDelCartModal(d.productId,d.product.title,d.id,d.qty)},[mt,f("刪除 ")],8,bt)]),t("td",yt,[t("img",{src:d.product.imageUrl,alt:d.product.title,class:"img-fluid"},null,8,Ct)]),t("td",Dt,[t("span",xt,g(d.product.title),1)]),t("td",It,[t("div",vt,[kt,t("div",wt,[t("button",{class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",disabled:d.qty===1,onClick:m=>l.decrementQuantity(d.id,d.qty,d.price)},[e.status.loadingItem4===d.id?(c(),h("span",Tt)):D("",!0),Lt],8,Mt),$(t("input",{min:"1",max:"10",type:"number",disabled:d.qty>10,class:"form-control rounded-0 border border-dark d-flex","onUpdate:modelValue":m=>d.qty=m,readonly:"",style:{"text-align":"center"}},null,8,$t),[[P,d.qty]]),t("button",{class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",onClick:m=>l.incrementQuantity(d.id,d.qty,d.price,d.product.max_travelers)},[e.status.loadingItem2===d.id?(c(),h("span",St)):D("",!0),Et],8,Pt)])])]),t("td",Vt,[t("span",Nt,g(l.thousand(d.price)),1)]),t("td",At,[t("span",Ft,g(l.thousand(d.final_total)),1)])]))),128))]),t("tfoot",null,[t("tr",Bt,[t("td",jt,[Qt,f(" "+g(e.cartsData?e.cartsData.length:0)+" 項旅遊方案 ",1)])]),t("tr",Ut,[t("td",qt,[Gt,f(" "+g(e.cartsData&&e.cartsData.final_total!==void 0?l.thousand(e.cartsData.final_total):0)+" 元 ",1)])])])],64))])]),t("div",zt,[y(b,{class:"btn-outline-square w-50 w-md-25 fs-5 mt-4 me-1",to:"/TouristPackage",onClick:a[0]||(a[0]=d=>l.redirectToA("全部"))},{default:I(()=>[f("繼續預約")]),_:1}),e.cartsLength===0?(c(),h("button",Ht," 請預約旅遊方案 ")):(c(),L(b,{key:1,class:"btn-square mt-4 fs-5 w-50 w-md-25",to:"/cart/CartForm",onClick:a[1]||(a[1]=d=>l.saveCartData(e.cartsData.final_total,e.cartsData.total))},{default:I(()=>[f("下一步")]),_:1}))])]),y(k,{ref:"delModal","user-carts":e.userCarts,"delete-cart":l.deleteCart,"save-carts-del-modal":e.saveCartsDelModal},null,8,["user-carts","delete-cart","save-carts-del-modal"])],64)}const Xt=v(R,[["render",Ot],["__scopeId","data-v-3efa3263"]]);export{Xt as default};
