import{C as w}from"./CartNavbar-yXpmCdAB.js";import{M}from"./bootstrap.esm-kE75U2LM.js";import{_ as v,o as i,c as h,a as t,t as f,d as g,b as C,j as y,F as x,h as L,w as I,g as T,r as D,i as $,v as S,p as P,f as E}from"./index-2WhFc1Hy.js";import{s as p}from"./sweetAlert-Szd-9iv_.js";const V={props:{userCarts:Array,deleteCart:Function,saveCartsDelModal:Object},data(){return{delModal:null}},methods:{openModal(){this.delModal.show()},closeModal(){this.delModal.hide()}},mounted(){this.delModal=new M(this.$refs.delCartModal)}},N={class:"modal fade",id:"delCartModal",tabindex:"-1",role:"dialog","aria-labelledby":"exampleModalLabel","aria-hidden":"true",ref:"delCartModal"},A={class:"modal-dialog",role:"document"},F={class:"modal-content border-0"},B={class:"modal-header bg-danger text-white"},j={class:"modal-title"},Q=t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"},null,-1),U={class:"modal-body"},q={class:"text-danger me-2"},G=t("br",null,null,-1),z={class:"text-primary"},H={class:"modal-footer"},O=t("button",{type:"button",class:"btn btn-outline-secondary","data-bs-dismiss":"modal"}," 取消 ",-1);function J(s,a,d,r,e,l){return i(),h("div",N,[t("div",A,[t("div",F,[t("div",B,[t("h5",j,[t("span",null,"刪除購物車編號: "+f(d.saveCartsDelModal.cartId),1)]),Q]),t("div",U,[g(" 是否刪除 "),t("strong",q,"預約行程名稱："+f(d.saveCartsDelModal.productTitle),1),G,t("span",z,"預約數量："+f(d.saveCartsDelModal.qty)+"位",1),g("(刪除後將無法恢復)。 ")]),t("div",H,[O,t("button",{type:"button",class:"btn btn-danger",onClick:a[0]||(a[0]=c=>d.deleteCart(d.saveCartsDelModal.cartId,d.saveCartsDelModal.productTitle))},"確認刪除")])])])],512)}const K=v(V,[["render",J]]),_="https://two024-south-json-server-vercel.onrender.com",R={components:{CartNavbar:w,DelCartModal:K},data(){return{userId:"",products:[],enabledProducts:[],carts:[],userCarts:[],newCarts:[],saveCartsDelModal:{},cartsData:[],isCartProductsFetched:!1,isGetProductsTriggered:!1,isGetCartsTriggered:!1,quantity:"",cartIdData:[],resData:[],isLoading:!1,status:{loadingItem:!1,loadingItem2:"",loadingItem3:"",loadingItem4:"",loadingItem5:""},cartsLength:0}},methods:{redirectToA(s){this.$root.navigatedFromHeader=!0,this.$router.push({path:"/TouristPackage",query:{category:s}})},getCarts(){this.axios.get(`${_}/carts`).then(s=>{this.carts=s.data,this.carts.forEach(a=>{a.userId===this.userId&&this.userCarts.push(a)}),this.cartsLength=this.userCarts.length,this.getProducts()}).catch(s=>{p.threeLayerCheckType("error","取得購物車資料失敗")})},getCart(){this.axios.get(`${_}/carts`).then(s=>{this.userCarts=s.data.filter(a=>a.userId===this.userId),this.cartsLength=this.userCarts.length,this.userCarts.length===0?this.$emitter.emit("updateCartNum",0):this.$emitter.emit("updateCartNum",this.userCarts.length)}).catch(s=>{p.threeLayerCheckType("error","取得購物車資料失敗")})},deleteCart(s,a){this.status.loadingItem3=s,this.status.loadingItem=!0,this.$refs.delModal.closeModal(),this.axios.delete(`${_}/carts/${s}`).then(d=>{this.status.loadingItem3="",this.cartsData=this.cartsData.filter(l=>l.id!==s);let r=0;this.cartsData.forEach(l=>{r+=l.final_total}),this.cartsData.total=r;let e=1;this.cartsData.final_total=r*e,this.status.loadingItem=!1,this.getCart()}).catch(d=>{this.status.loadingItem3="",p.threeLayerCheckType("error","刪除購物車資料失敗"),this.status.loadingItem=!1})},openDelCartModal(s,a,d,r){Array.isArray(this.userCarts)||(this.userCarts=[]),this.saveCartsDelModal={cartId:d,productId:s,productTitle:a,qty:r},this.$refs.delModal.openModal()},thousand(s){return s!==void 0&&(s=s.toString().replace(new RegExp("\\B(?<!\\.\\d*)(?=(\\d{3})+(?!\\d))","g"),",")),`$ ${s}`},getProducts(){this.axios.get(`${_}/products`).then(s=>{this.products=s.data,this.products.forEach(r=>{r.is_enabled===1&&this.enabledProducts.push(r)});let a=0;this.userCarts.forEach(r=>{const e=r.productId,l=this.enabledProducts.find(c=>c.id===e);l&&(r.product=l,a+=r.final_total,this.cartsData.push(r))}),this.isLoading=!1,this.cartsData.total=a;let d=1;this.cartsData.final_total=a*d}).catch(s=>{this.isLoading=!1,p.threeLayerCheckType("error","取得產品資料失敗")})},incrementQuantity(s,a,d,r){if(this.status.loadingItem2=s,a<r){a+=1;let e=1;this.axios.patch(`${_}/carts/${s}`,{qty:a,price:d,total:a*d,final_total:a*d*e}).then(l=>{this.status.loadingItem2="";const c=this.cartsData.findIndex(u=>u.id===s);if(c!==-1){this.cartsData[c].qty=a,this.cartsData[c].final_total=a*d*e;let u=0;this.cartsData.forEach(m=>{u+=m.final_total}),this.cartsData.total=u,this.cartsData.final_total=u*e}}).catch(l=>{p.threeLayerCheckType("error","增加購物車預約數量失敗")})}else this.status.loadingItem2="",p.threeLayerCheckType("warning",`預約人數上限為${r}人`)},decrementQuantity(s,a,d){if(this.status.loadingItem4=s,a>1){a-=1;let r=1;this.axios.patch(`${_}/carts/${s}`,{qty:a,price:d,total:a*d,final_total:a*d*r}).then(e=>{this.status.loadingItem4="";const l=this.cartsData.findIndex(c=>c.id===s);if(l!==-1){this.cartsData[l].qty=a,this.cartsData[l].final_total=a*d*r;let c=0;this.cartsData.forEach(u=>{c+=u.final_total}),this.cartsData.total=c,this.cartsData.final_total=c*r}}).catch(e=>{this.status.loadingItem4="",alert("更新購物車資料失敗")})}},back(){this.$router.back()},getCookie(s){const a=document.cookie.split(";");for(let d of a){const[r,e]=d.trim().split("=");if(r===s)return e}return null},getCartSData(){this.axios.get(`${_}/cartsData`).then(s=>{this.cartIdData=s.data})},saveCartData(s,a){const d=this.cartIdData.some(e=>e.userId===this.userId&&e.status===!1);let r=0;this.cartIdData.forEach(e=>{e.userId===this.userId&&e.status===!1&&(r=e.id)}),d&&r!==0?this.axios.put(`${_}/cartsData/${r}`,{data:this.cartsData,total:a,final_total:s,status:!1,userId:this.userId,orderStatus:!1}).then(e=>{document.cookie=`cartDataId=${r}`,this.getCartSData()}).catch(e=>{p.threeLayerCheckType("error","更新購物車資料失敗")}):this.axios.post(`${_}/cartsData`,{data:this.cartsData,total:a,final_total:s,status:!1,userId:this.userId,orderStatus:!1}).then(e=>{document.cookie=`cartDataId=${e.data.id}`,this.getCartSData()}).catch(e=>{p.threeLayerCheckType("error","儲存購物車資料失敗")})}},mounted(){const s=this.getCookie("userId");this.userId=s*1,this.isLoading=!0,this.getCarts(),this.getCartSData(),window.scrollTo(0,0)}},n=s=>(P("data-v-c1399f5f"),s=s(),E(),s),W={class:"container py-10 py-lg-30"},X={class:"row"},Y={class:"col-md-6 mx-auto pb-5 pb-lg-15"},Z={class:"table-responsive"},tt={class:"table align-middle table-rwd"},st=n(()=>t("tr",{class:"tr-only-hide"},[t("th",{style:{width:"100px"}}),t("th",{style:{width:"170px"}},"圖片"),t("th",{style:{width:"170px"}},"行程名稱"),t("th",{style:{width:"170px"}},"數量/單位"),t("th",{style:{width:"100px"},class:"text-end"},"單價"),t("th",{class:"text-end",style:{width:"100px"}},"小計")],-1)),et={key:0,class:"d-md-none"},at=n(()=>t("th",{style:{width:"80px"}},null,-1)),ot=n(()=>t("th",{style:{width:"170px"}},"圖片",-1)),rt=n(()=>t("th",{style:{width:"170px"}},"行程名稱",-1)),dt=n(()=>t("th",{style:{width:"170px"}},"數量/單位",-1)),lt=n(()=>t("th",{style:{width:"100px"},class:"text-end"},"單價",-1)),nt=n(()=>t("th",{class:"text-end",style:{width:"100px"}},"小計",-1)),it=[at,ot,rt,dt,lt,nt],ct={key:0},ht=n(()=>t("tr",null,[t("td",{colspan:"6",class:"text-center",style:{height:"150px"}},[t("div",{class:"spinner-border",role:"status",style:{width:"3rem",height:"3rem",color:"#43b8bd"}},[t("span",{class:"visually-hidden"},"Loading...")])])],-1)),ut=[ht],_t={key:0},pt=n(()=>t("td",{colspan:"6",class:"text-center"},"購物車是空的",-1)),ft=[pt],gt={"data-th":""},bt=["onClick"],mt=n(()=>t("i",{class:"bi bi-x"},null,-1)),Ct={"data-th":"圖片",class:""},yt=["src","alt"],Dt={"data-th":"行程名稱",class:"fs-6 pb-0 pb-md-2"},xt={class:"td-p-left"},It={class:"py-0 py-md-2"},vt={class:"td-number-direction"},kt=n(()=>t("span",{class:"fw-bold d-md-none fs-6"},"數量/單位",-1)),wt={class:"input-group my-3 w-length"},Mt=["onClick"],Lt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Tt=n(()=>t("i",{class:"bi bi-dash-lg"},null,-1)),$t=["onClick"],St={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Pt=n(()=>t("i",{class:"bi bi-trash"},null,-1)),Et=["disabled","onUpdate:modelValue"],Vt=["onClick"],Nt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},At=n(()=>t("i",{class:"bi bi-plus-lg"},null,-1)),Ft={"data-th":"單價",class:"text-end"},Bt={class:"td-p-left"},jt={class:"text-end","data-th":"小計"},Qt={class:"td-p-left"},Ut={class:"tr-border-bottom-0"},qt={colspan:"6",class:"text-end text-success"},Gt=n(()=>t("span",{class:"td-p-right"},"預約",-1)),zt={class:"tr-border-bottom-0"},Ht={colspan:"6",class:"text-end fs-5"},Ot=n(()=>t("span",{class:"td-p-right"},"總計 ",-1)),Jt={class:"d-flex justify-content-between"},Kt={key:0,class:"btn btn-danger mt-4 fs-5 w-50 w-md-25 disabled btn-danger-rounded",type:"button"};function Rt(s,a,d,r,e,l){const c=D("VueLoading"),u=D("CartNavbar"),m=D("router-link"),k=D("del-cart-modal");return i(),h(x,null,[C(c,{active:e.isLoading,class:"text-center","z-index":1060},null,8,["active"]),t("div",W,[t("div",X,[t("div",Y,[C(u)])]),t("div",Z,[t("table",tt,[t("thead",null,[st,e.cartsData.length===0?(i(),h("tr",et,it)):y("",!0)]),e.status.loadingItem?(i(),h("tbody",ct,ut)):(i(),h(x,{key:1},[t("tbody",null,[e.cartsData.length===0?(i(),h("tr",_t,ft)):(i(!0),h(x,{key:1},L(e.cartsData,o=>(i(),h("tr",{key:o.id},[t("td",gt,[t("button",{type:"button",class:"btn btn-outline-danger btn-sm",onClick:b=>l.openDelCartModal(o.productId,o.product.title,o.id,o.qty)},[mt,g("刪除 ")],8,bt)]),t("td",Ct,[t("img",{src:o.product.imageUrl,alt:o.product.title,class:"img-fluid"},null,8,yt)]),t("td",Dt,[t("span",xt,f(o.product.title),1)]),t("td",It,[t("div",vt,[kt,t("div",wt,[o.qty>1?(i(),h("button",{key:0,class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",onClick:b=>l.decrementQuantity(o.id,o.qty,o.price)},[e.status.loadingItem4===o.id?(i(),h("span",Lt)):y("",!0),Tt],8,Mt)):(i(),h("button",{key:1,type:"button",class:"btn btn-outline-danger rounded-0 btn-sm",onClick:b=>l.openDelCartModal(o.productId,o.product.title,o.id,o.qty)},[e.status.loadingItem3===o.id?(i(),h("span",St)):y("",!0),Pt],8,$t)),$(t("input",{min:"1",max:"10",type:"number",disabled:o.qty>10,class:"form-control rounded-0 border border-dark d-flex","onUpdate:modelValue":b=>o.qty=b,readonly:"",style:{"text-align":"center"}},null,8,Et),[[S,o.qty]]),t("button",{class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",onClick:b=>l.incrementQuantity(o.id,o.qty,o.price,o.product.max_travelers)},[e.status.loadingItem2===o.id?(i(),h("span",Nt)):y("",!0),At],8,Vt)])])]),t("td",Ft,[t("span",Bt,f(l.thousand(o.price)),1)]),t("td",jt,[t("span",Qt,f(l.thousand(o.final_total)),1)])]))),128))]),t("tfoot",null,[t("tr",Ut,[t("td",qt,[Gt,g(" "+f(e.cartsData?e.cartsData.length:0)+" 項旅遊方案 ",1)])]),t("tr",zt,[t("td",Ht,[Ot,g(" "+f(e.cartsData&&e.cartsData.final_total!==void 0?l.thousand(e.cartsData.final_total):0)+" 元 ",1)])])])],64))])]),t("div",Jt,[C(m,{class:"btn-outline-square w-50 w-md-25 fs-5 mt-4 me-1",to:"/TouristPackage",onClick:a[0]||(a[0]=o=>l.redirectToA("全部"))},{default:I(()=>[g("繼續預約")]),_:1}),e.cartsLength===0?(i(),h("button",Kt," 請預約旅遊方案 ")):(i(),T(m,{key:1,class:"btn-square mt-4 fs-5 w-50 w-md-25",to:"/cart/CartForm",onClick:a[1]||(a[1]=o=>l.saveCartData(e.cartsData.final_total,e.cartsData.total))},{default:I(()=>[g("下一步")]),_:1}))])]),C(k,{ref:"delModal","user-carts":e.userCarts,"delete-cart":l.deleteCart,"save-carts-del-modal":e.saveCartsDelModal},null,8,["user-carts","delete-cart","save-carts-del-modal"])],64)}const ts=v(R,[["render",Rt],["__scopeId","data-v-c1399f5f"]]);export{ts as default};
