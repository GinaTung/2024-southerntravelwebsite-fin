import{C as w}from"./CartNavbar-pNeg71Y7.js";import{M}from"./bootstrap.esm-L6PKxYmp.js";import{_ as v,o as c,c as h,a as t,t as g,d as f,b as C,l as D,F as x,i as T,w as I,h as L,r as y,k as $,v as P,p as S,f as E}from"./index-d8UUWlQV.js";import{s as _}from"./sweetAlert-26C70qVf.js";const V={props:{userCarts:Array,deleteCart:Function,saveCartsDelModal:Object},data(){return{delModal:null}},methods:{openModal(){this.delModal.show()},closeModal(){this.delModal.hide()}},mounted(){this.delModal=new M(this.$refs.delCartModal)}},N={class:"modal fade",id:"delCartModal",tabindex:"-1",role:"dialog","aria-labelledby":"exampleModalLabel","aria-hidden":"true",ref:"delCartModal"},A={class:"modal-dialog",role:"document"},F={class:"modal-content border-0"},B={class:"modal-header bg-danger text-white"},Q={class:"modal-title"},U=t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"},null,-1),j={class:"modal-body"},q={class:"text-danger me-2"},G=t("br",null,null,-1),z={class:"text-primary"},H={class:"modal-footer"},O=t("button",{type:"button",class:"btn btn-outline-secondary","data-bs-dismiss":"modal"}," 取消 ",-1);function J(s,a,r,o,e,l){return c(),h("div",N,[t("div",A,[t("div",F,[t("div",B,[t("h5",Q,[t("span",null,"刪除購物車編號: "+g(r.saveCartsDelModal.cartId),1)]),U]),t("div",j,[f(" 是否刪除 "),t("strong",q,"預約行程名稱："+g(r.saveCartsDelModal.productTitle),1),G,t("span",z,"預約數量："+g(r.saveCartsDelModal.qty)+"位",1),f("(刪除後將無法恢復)。 ")]),t("div",H,[O,t("button",{type:"button",class:"btn btn-danger",onClick:a[0]||(a[0]=i=>r.deleteCart(r.saveCartsDelModal.cartId,r.saveCartsDelModal.productTitle))},"確認刪除")])])])],512)}const K=v(V,[["render",J]]),p="https://two024-south-json-server-vercel.onrender.com",R={components:{CartNavbar:w,DelCartModal:K},data(){return{userId:"",products:[],enabledProducts:[],carts:[],userCarts:[],newCarts:[],saveCartsDelModal:{},cartsData:[],isCartProductsFetched:!1,isGetProductsTriggered:!1,isGetCartsTriggered:!1,quantity:"",cartIdData:[],resData:[],isLoading:!1,status:{loadingItem:!1,loadingItem2:"",loadingItem3:"",loadingItem4:"",loadingItem5:""},cartsLength:0}},methods:{redirectToA(s){this.$root.navigatedFromHeader=!0,this.$router.push({path:"/TouristPackage",query:{category:s}})},getCarts(){this.axios.get(`${p}/carts`).then(s=>{this.carts=s.data,this.carts.forEach(a=>{a.userId===this.userId&&this.userCarts.push(a)}),this.cartsLength=this.userCarts.length,this.getProducts()}).catch(s=>{_.threeLayerCheckType("error","取得購物車資料失敗")})},getCart(){this.axios.get(`${p}/carts`).then(s=>{this.userCarts=s.data.filter(a=>a.userId===this.userId),window.scrollTo(0,0),this.cartsLength=this.userCarts.length,this.userCarts.length===0?(this.$emitter.emit("updateCartNum",0),_.fourLayerCheckType("warning","目前無購物車資料","將在","秒後自動跳轉至旅遊景點方案頁面","預約購買旅遊方案"),setTimeout(()=>{this.$router.push({path:"/TouristPackage"})},11e3)):this.$emitter.emit("updateCartNum",this.userCarts.length)}).catch(s=>{_.threeLayerCheckType("error","取得購物車資料失敗")})},deleteCart(s,a){this.status.loadingItem3=s,this.status.loadingItem=!0,this.$refs.delModal.closeModal(),this.axios.delete(`${p}/carts/${s}`).then(r=>{this.status.loadingItem3="",this.cartsData=this.cartsData.filter(l=>l.id!==s);let o=0;this.cartsData.forEach(l=>{o+=l.final_total}),this.cartsData.total=o;let e=1;this.cartsData.final_total=o*e,this.status.loadingItem=!1,this.getCart()}).catch(r=>{this.status.loadingItem3="",_.threeLayerCheckType("error","刪除購物車資料失敗"),this.status.loadingItem=!1})},openDelCartModal(s,a,r,o){Array.isArray(this.userCarts)||(this.userCarts=[]),this.saveCartsDelModal={cartId:r,productId:s,productTitle:a,qty:o},this.$refs.delModal.openModal()},thousand(s){return s!==void 0&&(s=s.toString().replace(new RegExp("\\B(?<!\\.\\d*)(?=(\\d{3})+(?!\\d))","g"),",")),`$ ${s}`},getProducts(){this.axios.get(`${p}/products`).then(s=>{this.products=s.data,this.products.forEach(o=>{o.is_enabled===1&&this.enabledProducts.push(o)});let a=0;this.userCarts.forEach(o=>{const e=o.productId,l=this.enabledProducts.find(i=>i.id===e);l&&(o.product=l,a+=o.final_total,this.cartsData.push(o))}),this.isLoading=!1,this.cartsData.total=a;let r=1;this.cartsData.final_total=a*r}).catch(s=>{this.isLoading=!1,_.threeLayerCheckType("error","取得產品資料失敗")})},incrementQuantity(s,a,r,o){if(this.status.loadingItem2=s,a<o){a+=1;let e=1;this.axios.patch(`${p}/carts/${s}`,{qty:a,price:r,total:a*r,final_total:a*r*e}).then(l=>{this.status.loadingItem2="";const i=this.cartsData.findIndex(u=>u.id===s);if(i!==-1){this.cartsData[i].qty=a,this.cartsData[i].final_total=a*r*e;let u=0;this.cartsData.forEach(b=>{u+=b.final_total}),this.cartsData.total=u,this.cartsData.final_total=u*e}}).catch(l=>{_.threeLayerCheckType("error","增加購物車預約數量失敗")})}else this.status.loadingItem2="",_.threeLayerCheckType("warning",`預約人數上限為${o}人`)},decrementQuantity(s,a,r){if(this.status.loadingItem4=s,a>1){a-=1;let o=1;this.axios.patch(`${p}/carts/${s}`,{qty:a,price:r,total:a*r,final_total:a*r*o}).then(e=>{this.status.loadingItem4="";const l=this.cartsData.findIndex(i=>i.id===s);if(l!==-1){this.cartsData[l].qty=a,this.cartsData[l].final_total=a*r*o;let i=0;this.cartsData.forEach(u=>{i+=u.final_total}),this.cartsData.total=i,this.cartsData.final_total=i*o}}).catch(e=>{this.status.loadingItem4="",alert("更新購物車資料失敗")})}else this.status.loadingItem2=""},back(){this.$router.back()},getCookie(s){const a=document.cookie.split(";");for(let r of a){const[o,e]=r.trim().split("=");if(o===s)return e}return null},getCartSData(){this.axios.get(`${p}/cartsData`).then(s=>{this.cartIdData=s.data})},saveCartData(s,a){const r=this.cartIdData.some(e=>e.userId===this.userId&&e.status===!1);let o=0;this.cartIdData.forEach(e=>{e.userId===this.userId&&e.status===!1&&(o=e.id)}),r&&o!==0?this.axios.put(`${p}/cartsData/${o}`,{data:this.cartsData,total:a,final_total:s,status:!1,userId:this.userId,orderStatus:!1}).then(e=>{document.cookie=`cartDataId=${o}`,this.getCartSData()}).catch(e=>{_.threeLayerCheckType("error","更新購物車資料失敗")}):this.axios.post(`${p}/cartsData`,{data:this.cartsData,total:a,final_total:s,status:!1,userId:this.userId,orderStatus:!1}).then(e=>{document.cookie=`cartDataId=${e.data.id}`,this.getCartSData()}).catch(e=>{_.threeLayerCheckType("error","儲存購物車資料失敗")})}},mounted(){const s=this.getCookie("userId");this.userId=s*1,this.isLoading=!0,this.getCarts(),this.getCartSData(),window.scrollTo(0,0)}},n=s=>(S("data-v-a6e593de"),s=s(),E(),s),W={class:"container py-10 py-lg-30"},X={class:"row"},Y={class:"col-md-6 mx-auto pb-5 pb-lg-15"},Z={class:"table-responsive"},tt={class:"table align-middle table-rwd"},st=n(()=>t("tr",{class:"tr-only-hide"},[t("th",{style:{width:"100px"}}),t("th",{style:{width:"170px"}},"圖片"),t("th",{style:{width:"170px"}},"行程名稱"),t("th",{style:{width:"170px"}},"數量/單位"),t("th",{style:{width:"100px"},class:"text-end"},"單價"),t("th",{class:"text-end",style:{width:"100px"}},"小計")],-1)),et={key:0,class:"d-md-none"},at=n(()=>t("th",{style:{width:"80px"}},null,-1)),ot=n(()=>t("th",{style:{width:"170px"}},"圖片",-1)),rt=n(()=>t("th",{style:{width:"170px"}},"行程名稱",-1)),dt=n(()=>t("th",{style:{width:"170px"}},"數量/單位",-1)),lt=n(()=>t("th",{style:{width:"100px"},class:"text-end"},"單價",-1)),nt=n(()=>t("th",{class:"text-end",style:{width:"100px"}},"小計",-1)),it=[at,ot,rt,dt,lt,nt],ct={key:0},ht=n(()=>t("tr",null,[t("td",{colspan:"6",class:"text-center",style:{height:"150px"}},[t("div",{class:"spinner-border",role:"status",style:{width:"3rem",height:"3rem",color:"#43b8bd"}},[t("span",{class:"visually-hidden"},"Loading...")])])],-1)),ut=[ht],_t={key:0},pt=n(()=>t("td",{colspan:"6",class:"text-center"},"購物車是空的",-1)),gt=[pt],ft={"data-th":""},bt=["onClick"],mt=n(()=>t("i",{class:"bi bi-x"},null,-1)),Ct={"data-th":"圖片",class:""},yt=["src","alt"],Dt={"data-th":"行程名稱",class:"fs-6 pb-0 pb-md-2"},xt={class:"td-p-left"},It={class:"py-0 py-md-2"},vt={class:"td-number-direction"},kt=n(()=>t("span",{class:"fw-bold d-md-none fs-6"},"數量/單位",-1)),wt={class:"input-group my-3 w-length"},Mt=["disabled","onClick"],Tt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Lt=n(()=>t("i",{class:"bi bi-dash-lg"},null,-1)),$t=["disabled","onUpdate:modelValue"],Pt=["onClick"],St={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Et=n(()=>t("i",{class:"bi bi-plus-lg"},null,-1)),Vt={"data-th":"單價",class:"text-end"},Nt={class:"td-p-left"},At={class:"text-end","data-th":"小計"},Ft={class:"td-p-left"},Bt={class:"tr-border-bottom-0"},Qt={colspan:"6",class:"text-end text-success"},Ut=n(()=>t("span",{class:"td-p-right"},"預約",-1)),jt={class:"tr-border-bottom-0"},qt={colspan:"6",class:"text-end fs-5"},Gt=n(()=>t("span",{class:"td-p-right"},"總計 ",-1)),zt={class:"d-flex justify-content-between"},Ht={key:0,class:"btn btn-danger mt-4 fs-5 w-50 w-md-25 disabled btn-danger-rounded",type:"button"};function Ot(s,a,r,o,e,l){const i=y("VueLoading"),u=y("CartNavbar"),b=y("router-link"),k=y("del-cart-modal");return c(),h(x,null,[C(i,{active:e.isLoading,class:"text-center","z-index":1060},null,8,["active"]),t("div",W,[t("div",X,[t("div",Y,[C(u)])]),t("div",Z,[t("table",tt,[t("thead",null,[st,e.cartsData.length===0?(c(),h("tr",et,it)):D("",!0)]),e.status.loadingItem?(c(),h("tbody",ct,ut)):(c(),h(x,{key:1},[t("tbody",null,[e.cartsData.length===0?(c(),h("tr",_t,gt)):(c(!0),h(x,{key:1},T(e.cartsData,d=>(c(),h("tr",{key:d.id},[t("td",ft,[t("button",{type:"button",class:"btn btn-outline-danger btn-sm",onClick:m=>l.openDelCartModal(d.productId,d.product.title,d.id,d.qty)},[mt,f("刪除 ")],8,bt)]),t("td",Ct,[t("img",{src:d.product.imageUrl,alt:d.product.title,class:"img-fluid rounded-2 mt-1"},null,8,yt)]),t("td",Dt,[t("span",xt,g(d.product.title),1)]),t("td",It,[t("div",vt,[kt,t("div",wt,[t("button",{class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",disabled:d.qty===1,onClick:m=>l.decrementQuantity(d.id,d.qty,d.price)},[e.status.loadingItem4===d.id?(c(),h("span",Tt)):D("",!0),Lt],8,Mt),$(t("input",{min:"1",max:"10",type:"number",disabled:d.qty>10,class:"form-control rounded-0 border border-dark d-flex","onUpdate:modelValue":m=>d.qty=m,readonly:"",style:{"text-align":"center"}},null,8,$t),[[P,d.qty]]),t("button",{class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",onClick:m=>l.incrementQuantity(d.id,d.qty,d.price,d.product.max_travelers)},[e.status.loadingItem2===d.id?(c(),h("span",St)):D("",!0),Et],8,Pt)])])]),t("td",Vt,[t("span",Nt,g(l.thousand(d.price)),1)]),t("td",At,[t("span",Ft,g(l.thousand(d.final_total)),1)])]))),128))]),t("tfoot",null,[t("tr",Bt,[t("td",Qt,[Ut,f(" "+g(e.cartsData?e.cartsData.length:0)+" 項旅遊方案 ",1)])]),t("tr",jt,[t("td",qt,[Gt,f(" "+g(e.cartsData&&e.cartsData.final_total!==void 0?l.thousand(e.cartsData.final_total):0)+" 元 ",1)])])])],64))])]),t("div",zt,[C(b,{class:"btn-outline-square w-50 w-md-25 fs-5 mt-4 me-1",to:"/TouristPackage",onClick:a[0]||(a[0]=d=>l.redirectToA("全部"))},{default:I(()=>[f("繼續預約")]),_:1}),e.cartsLength===0?(c(),h("button",Ht," 請預約旅遊方案 ")):(c(),L(b,{key:1,class:"btn-square mt-4 fs-5 w-50 w-md-25",to:"/cart/CartForm",onClick:a[1]||(a[1]=d=>l.saveCartData(e.cartsData.final_total,e.cartsData.total))},{default:I(()=>[f("下一步")]),_:1}))])]),C(k,{ref:"delModal","user-carts":e.userCarts,"delete-cart":l.deleteCart,"save-carts-del-modal":e.saveCartsDelModal},null,8,["user-carts","delete-cart","save-carts-del-modal"])],64)}const Xt=v(R,[["render",Ot],["__scopeId","data-v-a6e593de"]]);export{Xt as default};
