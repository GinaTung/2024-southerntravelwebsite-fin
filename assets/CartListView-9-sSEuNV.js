import{C as v}from"./CartNavbar-nP1C2z6h.js";import{M as w}from"./bootstrap.esm-LLkl1X3A.js";import{_ as I,o as n,c,a as t,t as p,d as b,b as m,j as C,F as D,h as M,w as x,g as L,r as y,f as T,i as $}from"./index-RR-LHgYl.js";import{s as _}from"./sweetAlert-qsZBwJtF.js";const E={props:{userCarts:Array,deleteCart:Function,saveCartsDelModal:Object},data(){return{delModal:null}},methods:{openModal(){this.delModal.show()},closeModal(){this.delModal.hide()}},mounted(){this.delModal=new w(this.$refs.delCartModal)}},P={class:"modal fade",id:"delCartModal",tabindex:"-1",role:"dialog","aria-labelledby":"exampleModalLabel","aria-hidden":"true",ref:"delCartModal"},V={class:"modal-dialog",role:"document"},N={class:"modal-content border-0"},S={class:"modal-header bg-danger text-white"},B={class:"modal-title"},F=t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"},null,-1),j={class:"modal-body"},A={class:"text-danger me-2"},Q=t("br",null,null,-1),U={class:"text-primary"},q={class:"modal-footer"},G=t("button",{type:"button",class:"btn btn-outline-secondary","data-bs-dismiss":"modal"}," 取消 ",-1);function z(e,a,l,o,s,d){return n(),c("div",P,[t("div",V,[t("div",N,[t("div",S,[t("h5",B,[t("span",null,"刪除購物車編號: "+p(l.saveCartsDelModal.cartId),1)]),F]),t("div",j,[b(" 是否刪除 "),t("strong",A,"預約行程名稱："+p(l.saveCartsDelModal.productTitle),1),Q,t("span",U,"預約數量："+p(l.saveCartsDelModal.qty)+"位",1),b("(刪除後將無法恢復)。 ")]),t("div",q,[G,t("button",{type:"button",class:"btn btn-danger",onClick:a[0]||(a[0]=i=>l.deleteCart(l.saveCartsDelModal.cartId,l.saveCartsDelModal.productTitle))},"確認刪除")])])])],512)}const O=I(E,[["render",z]]),u="https://two024-south-json-server-vercel.onrender.com",H={components:{CartNavbar:v,DelCartModal:O},data(){return{userId:"",products:[],enabledProducts:[],carts:[],userCarts:[],newCarts:[],saveCartsDelModal:{},cartsData:[],isCartProductsFetched:!1,isGetProductsTriggered:!1,isGetCartsTriggered:!1,quantity:"",cartIdData:[],resData:[],isLoading:!1,status:{loadingItem:!1,loadingItem2:"",loadingItem3:"",loadingItem4:"",loadingItem5:""},cartsLength:0}},methods:{getCarts(){this.axios.get(`${u}/carts`).then(e=>{this.carts=e.data,this.carts.forEach(a=>{a.userId===this.userId&&this.userCarts.push(a)}),this.cartsLength=this.userCarts.length,this.getProducts()}).catch(e=>{_.threeLayerCheckType("error","取得購物車資料失敗")})},getCart(){this.axios.get(`${u}/carts`).then(e=>{this.userCarts=e.data.filter(a=>a.userId===this.userId),this.cartsLength=this.userCarts.length,this.userCarts.length===0?this.$emitter.emit("updateCartNum",0):this.$emitter.emit("updateCartNum",this.userCarts.length)}).catch(e=>{_.threeLayerCheckType("error","取得購物車資料失敗")})},deleteCart(e,a){this.status.loadingItem3=e,this.status.loadingItem=!0,this.$refs.delModal.closeModal(),this.axios.delete(`${u}/carts/${e}`).then(l=>{this.status.loadingItem3="",this.cartsData=this.cartsData.filter(d=>d.id!==e);let o=0;this.cartsData.forEach(d=>{o+=d.final_total}),this.cartsData.total=o;let s=1;this.cartsData.final_total=o*s,this.status.loadingItem=!1,this.getCart()}).catch(l=>{this.status.loadingItem3="",_.threeLayerCheckType("error","刪除購物車資料失敗"),this.status.loadingItem=!1})},openDelCartModal(e,a,l,o){Array.isArray(this.userCarts)||(this.userCarts=[]),this.saveCartsDelModal={cartId:l,productId:e,productTitle:a,qty:o},this.$refs.delModal.openModal()},thousand(e){return e!==void 0&&(e=e.toString().replace(new RegExp("\\B(?<!\\.\\d*)(?=(\\d{3})+(?!\\d))","g"),",")),`$ ${e}`},getProducts(){this.axios.get(`${u}/products`).then(e=>{this.products=e.data,this.products.forEach(o=>{o.is_enabled===1&&this.enabledProducts.push(o)});let a=0;this.userCarts.forEach(o=>{const s=o.productId,d=this.enabledProducts.find(i=>i.id===s);d&&(o.product=d,a+=o.final_total,this.cartsData.push(o))}),this.isLoading=!1,this.cartsData.total=a;let l=1;this.cartsData.final_total=a*l}).catch(e=>{this.isLoading=!1,_.threeLayerCheckType("error","取得產品資料失敗")})},incrementQuantity(e,a,l,o){if(this.status.loadingItem2=e,a<o){a+=1;let s=1;this.axios.patch(`${u}/carts/${e}`,{qty:a,price:l,total:a*l,final_total:a*l*s}).then(d=>{this.status.loadingItem2="";const i=this.cartsData.findIndex(h=>h.id===e);if(i!==-1){this.cartsData[i].qty=a,this.cartsData[i].final_total=a*l*s;let h=0;this.cartsData.forEach(f=>{h+=f.final_total}),this.cartsData.total=h,this.cartsData.final_total=h*s}}).catch(d=>{_.threeLayerCheckType("error","增加購物車預約數量失敗")})}else this.status.loadingItem2="",_.threeLayerCheckType("warning",`預約人數上限為${o}人`)},decrementQuantity(e,a,l){if(this.status.loadingItem4=e,a>1){a-=1;let o=1;this.axios.patch(`${u}/carts/${e}`,{qty:a,price:l,total:a*l,final_total:a*l*o}).then(s=>{this.status.loadingItem4="";const d=this.cartsData.findIndex(i=>i.id===e);if(d!==-1){this.cartsData[d].qty=a,this.cartsData[d].final_total=a*l*o;let i=0;this.cartsData.forEach(h=>{i+=h.final_total}),this.cartsData.total=i,this.cartsData.final_total=i*o}}).catch(s=>{this.status.loadingItem4="",alert("更新購物車資料失敗")})}},back(){this.$router.back()},getCookie(e){const a=document.cookie.split(";");for(let l of a){const[o,s]=l.trim().split("=");if(o===e)return s}return null},getCartSData(){this.axios.get(`${u}/cartsData`).then(e=>{this.cartIdData=e.data})},saveCartData(e,a){const l=this.cartIdData.some(s=>s.userId===this.userId&&s.status===!1);let o=0;this.cartIdData.forEach(s=>{s.userId===this.userId&&s.status===!1&&(o=s.id)}),l&&o!==0?this.axios.put(`${u}/cartsData/${o}`,{data:this.cartsData,total:a,final_total:e,status:!1,userId:this.userId,orderStatus:!1}).then(s=>{document.cookie=`cartDataId=${o}`,this.getCartSData()}).catch(s=>{_.threeLayerCheckType("error","更新購物車資料失敗")}):this.axios.post(`${u}/cartsData`,{data:this.cartsData,total:a,final_total:e,status:!1,userId:this.userId,orderStatus:!1}).then(s=>{document.cookie=`cartDataId=${s.data.id}`,this.getCartSData()}).catch(s=>{_.threeLayerCheckType("error","儲存購物車資料失敗")})}},mounted(){const e=this.getCookie("userId");this.userId=e*1,this.isLoading=!0,this.getCarts(),this.getCartSData(),window.scrollTo(0,0)}},J={class:"container py-10 py-lg-30"},K={class:"row"},R={class:"col-md-6 mx-auto pb-5 pb-lg-15"},W={class:"table-responsive"},X={class:"table align-middle table-rwd"},Y=t("tr",{class:"tr-only-hide"},[t("th",{style:{width:"100px"}}),t("th",{style:{width:"170px"}},"圖片"),t("th",{style:{width:"170px"}},"行程名稱"),t("th",{style:{width:"170px"}},"數量/單位"),t("th",{style:{width:"100px"},class:"text-end"},"單價"),t("th",{class:"text-end",style:{width:"100px"}},"小計")],-1),Z={key:0,class:"d-md-none"},tt=t("th",{style:{width:"80px"}},null,-1),st=t("th",{style:{width:"170px"}},"圖片",-1),et=t("th",{style:{width:"170px"}},"行程名稱",-1),at=t("th",{style:{width:"170px"}},"數量/單位",-1),ot=t("th",{style:{width:"100px"},class:"text-end"},"單價",-1),rt=t("th",{class:"text-end",style:{width:"100px"}},"小計",-1),lt=[tt,st,et,at,ot,rt],dt={key:0},nt=t("tr",null,[t("td",{colspan:"6",class:"text-center",style:{height:"150px"}},[t("div",{class:"spinner-border",role:"status",style:{width:"3rem",height:"3rem",color:"#43b8bd"}},[t("span",{class:"visually-hidden"},"Loading...")])])],-1),it=[nt],ct={key:0},ht=t("td",{colspan:"6",class:"text-center"},"購物車是空的",-1),ut=[ht],_t={"data-th":""},pt=["onClick"],bt=t("i",{class:"bi bi-x"},null,-1),gt={"data-th":"圖片",class:""},ft=["src","alt"],mt={"data-th":"行程名稱",class:"fs-6 pb-0 pb-md-2"},Ct={class:"td-p-left"},yt={class:"py-0 py-md-2"},Dt={class:"td-number-direction"},xt=t("span",{class:"fw-bold d-md-none fs-6"},"數量/單位",-1),It={class:"input-group my-3 w-length"},kt=["onClick"],vt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},wt=t("i",{class:"bi bi-dash-lg"},null,-1),Mt=["onClick"],Lt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Tt=t("i",{class:"bi bi-trash"},null,-1),$t=["disabled","onUpdate:modelValue"],Et=["onClick"],Pt={key:0,class:"spinner-border spinner-grow-sm",role:"status"},Vt=t("i",{class:"bi bi-plus-lg"},null,-1),Nt={"data-th":"單價",class:"text-end"},St={class:"td-p-left"},Bt={class:"text-end","data-th":"小計"},Ft={class:"td-p-left"},jt={class:"tr-border-bottom-0"},At={colspan:"6",class:"text-end text-success"},Qt=t("span",{class:"td-p-right"},"預約",-1),Ut={class:"tr-border-bottom-0"},qt={colspan:"6",class:"text-end fs-5"},Gt=t("span",{class:"td-p-right"},"總計 ",-1),zt={class:"d-flex justify-content-between"},Ot={key:0,class:"btn btn-danger mt-4 fs-5 w-50 w-md-25 disabled btn-danger-rounded",type:"button"};function Ht(e,a,l,o,s,d){const i=y("VueLoading"),h=y("CartNavbar"),f=y("router-link"),k=y("del-cart-modal");return n(),c(D,null,[m(i,{active:s.isLoading,class:"text-center","z-index":1060},null,8,["active"]),t("div",J,[t("div",K,[t("div",R,[m(h)])]),t("div",W,[t("table",X,[t("thead",null,[Y,s.cartsData.length===0?(n(),c("tr",Z,lt)):C("",!0)]),s.status.loadingItem?(n(),c("tbody",dt,it)):(n(),c(D,{key:1},[t("tbody",null,[s.cartsData.length===0?(n(),c("tr",ct,ut)):(n(!0),c(D,{key:1},M(s.cartsData,r=>(n(),c("tr",{key:r.id},[t("td",_t,[t("button",{type:"button",class:"btn btn-outline-danger btn-sm",onClick:g=>d.openDelCartModal(r.productId,r.product.title,r.id,r.qty)},[bt,b("刪除 ")],8,pt)]),t("td",gt,[t("img",{src:r.product.imageUrl,alt:r.product.title,class:"img-fluid"},null,8,ft)]),t("td",mt,[t("span",Ct,p(r.product.title),1)]),t("td",yt,[t("div",Dt,[xt,t("div",It,[r.qty>1?(n(),c("button",{key:0,class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",onClick:g=>d.decrementQuantity(r.id,r.qty,r.price)},[s.status.loadingItem4===r.id?(n(),c("span",vt)):C("",!0),wt],8,kt)):(n(),c("button",{key:1,type:"button",class:"btn btn-outline-danger rounded-0 btn-sm",onClick:g=>d.openDelCartModal(r.productId,r.product.title,r.id,r.qty)},[s.status.loadingItem3===r.id?(n(),c("span",Lt)):C("",!0),Tt],8,Mt)),T(t("input",{min:"1",max:"10",type:"number",disabled:r.qty>10,class:"form-control rounded-0 border border-dark d-flex","onUpdate:modelValue":g=>r.qty=g,readonly:"",style:{"text-align":"center"}},null,8,$t),[[$,r.qty]]),t("button",{class:"btn btn-outline-dark rounded-0 btn-sm",type:"button",onClick:g=>d.incrementQuantity(r.id,r.qty,r.price,r.product.max_travelers)},[s.status.loadingItem2===r.id?(n(),c("span",Pt)):C("",!0),Vt],8,Et)])])]),t("td",Nt,[t("span",St,p(d.thousand(r.price)),1)]),t("td",Bt,[t("span",Ft,p(d.thousand(r.final_total)),1)])]))),128))]),t("tfoot",null,[t("tr",jt,[t("td",At,[Qt,b(" "+p(s.cartsData?s.cartsData.length:0)+" 項行程 ",1)])]),t("tr",Ut,[t("td",qt,[Gt,b(" "+p(s.cartsData&&s.cartsData.final_total!==void 0?d.thousand(s.cartsData.final_total):0)+" 元 ",1)])])])],64))])]),t("div",zt,[m(f,{class:"btn-outline-square w-50 w-md-25 fs-5 mt-4 me-1",to:"/TouristPackage"},{default:x(()=>[b("繼續預約")]),_:1}),s.cartsLength===0?(n(),c("button",Ot," 請預約套裝行程 ")):(n(),L(f,{key:1,class:"btn-square mt-4 fs-5 w-50 w-md-25",to:"/cart/CartForm",onClick:a[0]||(a[0]=r=>d.saveCartData(s.cartsData.final_total,s.cartsData.total))},{default:x(()=>[b("下一步")]),_:1}))])]),m(k,{ref:"delModal","user-carts":s.userCarts,"delete-cart":d.deleteCart,"save-carts-del-modal":s.saveCartsDelModal},null,8,["user-carts","delete-cart","save-carts-del-modal"])],64)}const Xt=I(H,[["render",Ht]]);export{Xt as default};
